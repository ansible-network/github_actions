name: Retrieve collection information
description: Extract collection infromation from the galaxy.yml file

inputs:
  path:
    description: "Path to the galaxy.yml file"
    required: true
outputs:
  tar_file:
    description: The collection tarball when built
    value: ${{ steps.namespace.outputs.value }}-${{ steps.name.outputs.value }}-${{ steps.version.outputs.value }}.tar.gz
  collection_path:
    description: The final collection path
    value: /home/runner/collections/ansible_collections/${{ steps.namespace.outputs.value }}/${{ steps.name.outputs.value }}
  dependency:
    description: The collection dependency
    value: ${{ steps.dependency.outputs.value }}

runs:
  using: composite
  steps:
    - name: Github action python requirements
      run: pip3 install yq
      shell: bash

    - name: Get computed collection version
      id: version
      run: |
        echo "::set-output name=value::$(git describe --tags)"
      shell: bash
      working-directory: ${{ inputs.path }}

    - name: Set the version number in galaxy.yml
      run: |
        yq -yi '.version="${{ steps.version.output.value }}"' 'galaxy.yml'
      shell: bash
      working-directory: ${{ inputs.path }}

    - name: Extract collection namespace
      id: namespace
      run: |
        echo "::set-output name=value::$(yq -r '.namespace' 'galaxy.yml')"
      shell: bash
      working-directory: ${{ inputs.path }}

    - name: Extract collection name
      id: name
      run: |
        echo "::set-output name=value::$(yq -r '.name' 'galaxy.yml')"
      shell: bash
      working-directory: ${{ inputs.path }}

    - name: Extract dependency
      id: dependency
      run: |
        echo "::set-output name=value::$(yq -r '.dependencies | keys | join(" ")' 'galaxy.yml')"
      shell: bash
      working-directory: ${{ inputs.path }}

    - name: Github action python requirements
      run: pip3 uninstall yq -y
      shell: bash
